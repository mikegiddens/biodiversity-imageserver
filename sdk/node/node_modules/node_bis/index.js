var fs          = require("fs");
var http        = require("http");
var multiparter = require("multiparter");

var nodeBIS = function(key, url){

	function create_object(file, callback){
		var err = null;
		var request = new multiparter.request(http, {
			host: this.url,
			port: 80,
			path: '/dev/resources/api/api.php',
			method: 'POST'
		});

		// add some plain params here
		request.setParam("cmd", "createObject");
		request.setParam("key", this.key);
		
		request.addStream(
				"filename",
				"test",
				"image/gif",
				fs.statSync(file).size,
				fs.createReadStream(file)
		);

		// send request and receive response
		request.send(function(error, response) {

			if (error) {
				return(callback(error, null));
			}
	
			var data = "";
	
			response.setEncoding("utf8");
	
			response.on("data", function(chunk) {
					data += chunk;
			});
	
			response.on("end", function() {
				return(callback(err, data));
			});
	
			response.on("error", function(error) {
					return(callback(error, null));
			});
		});

	}
	
	return {
		create_object: create_object,
		key: key || '',
		url: url || ''
	};

}

module.exports = nodeBIS;