
Ext.define('SilverMeasure.TileLayer',{extend:'Ext.Component',alias:'widget.tilelayer',zoomLevel:5,tileSize:256,tileTpl:'',afterRender:function(){this.tiles=[];this.xtpl=Ext.core.DomHelper.createTemplate({tag:'img',id:'tile-{0}-{1}-{2}',src:Ext.BLANK_IMAGE_URL,width:256,height:256,cls:'tile'});this.createTiles(this.zoomLevel);this.el.setWidth((this.tileSize*(Math.pow(this.zoomLevel,2)))+2);this.callParent(arguments);},createTiles:function(zoomLevel){this.zoomLevel=zoomLevel;var tileCount=Math.pow(zoomLevel,2);for(var i=1;i<=tileCount;i++){this.tiles[i]=new Array();for(var j=1;j<=tileCount;j++){this.tiles[i][j]=this.xtpl.append(this.el.dom,[i,j]);}}
this.lastDiv=Ext.core.DomHelper.append(this.el.dom,{tag:'div',style:'clear:both'});},removeTiles:function(){var tileCount=Math.pow(this.zoomLevel,2);for(var i=1;i<=tileCount;i++){for(var j=1;j<=tileCount;j++){Ext.fly(this.tiles[i][j]).remove();}}
Ext.fly(this.lastDiv).remove();this.tiles=new Array();},getTile:function(x,y){return this.tiles[x][y];},isBlankTile:function(x,y){return((this.tiles[x][y].rendered)?false:true);},setImage:function(x,y,url){if(this.tiles[x]&&this.tiles[x][y]&&!this.tiles[x][y].rendered){this.tiles[x][y].src=url;this.tiles[x][y].rendered=true;}},showTile:function(x,y){if(this.tiles[x]&&this.tiles[x][y]&&!this.tiles[x][y].rendered){var tileCount=Math.pow(this.zoomLevel,2);var imgName=((x-1)*(tileCount))+(y-1);var url=Ext.util.Format.format(this.tileTpl,x,y,this.zoomLevel,imgName);this.setImage(x,y,url);}},showTilesByRange:function(topLeft,bottomRight){for(var x=topLeft.row;x<=bottomRight.row;x++){for(var y=topLeft.column;y<=bottomRight.column;y++){this.showTile(x,y);}}},showAllTiles:function(){var tileCount=Math.pow(this.zoomLevel,2);for(var i=1;i<=tileCount;i++){for(var j=1;j<=tileCount;j++){var imgName=((i-1)*(tileCount))+(j-1);var url=Ext.util.Format.format(this.tileTpl,i,j,this.zoomLevel,imgName);this.setImage(i,j,url);}}},hideTile:function(x,y){this.setImage(x,y,Ext.BLANK_IMAGE_URL);}});

Ext.define('SilverMeasure.ImageZoom',{extend:'Ext.Component',requires:['Ext.dd.DragTracker','Ext.util.KeyNav'],alias:'widget.imagezoom',draggable:true,isMouseScroll:true,currentZoomLevel:1,zoomControl:true,rototeControl:true,scaleControl:true,copyRightControl:true,copyrightText:'',panControl:true,rototeMin:-180,rototeMax:180,tileLayers:new Array(),currentLayer:'',currentCircle:'',previousLayer:'',backgroundColor:'#EFEFEF',zoomMin:1,zoomMax:10,dblClickZoom:true,isImageLoaded:false,spaceHotkey:true,currentShape:'',listeners:{'resize':function(){this.getTileByOffset();}},renderTpl:new Ext.XTemplate('<div id="tileContainer" style="overflow: hidden; width: 100%; height: 100%; position: relative; left: 0px; top: 0px;">','<div id="zoomControlContainer" class="imagezoom-zoomcontrol"></div>','<div id="dragContainer" style="position: relative; left: 0px; top: 0px; z-index: 0;"></div>','</div>'),afterRender:function(a,b,c){this.el.applyStyles({overflow:'hidden'});this.tileContainerEl=Ext.get('tileContainer');this.dragEl=Ext.get('dragContainer');this.addCls('imagezoom-opencursor');this.setBackgroundColor(this.backgroundColor);this.dragEl.applyStyles({overflow:'hidden'});this.loadDragTracker();this.initKeyEvent();this.initMouseEvent();this.callParent(arguments);},destroy:function(){if(this.tracker){this.tracker.destroy();}
if(this.zoomControl){this.zoomContainer.destroy();}
for(var i=0;i<this.tileLayers.length;i++){if(Ext.isDefined(this.tileLayers[i])){this.tileLayers[i].destroy();}
delete this.tileLayers[i];}},enableDblClickZoom:function(){this.dragEl.on('dblclick',function(e){if(this.currentShape!='polygon'&&this.currentShape!='polyline'){if(this.currentZoomLevel<this.zoomMax){this.zoom(e,true);}}},this);},getRowTileCount:function(){return(this.currentZoomLevel);},getTileCount:function(){return(Math.pow(this.currentZoomLevel,2));},getTileByOffset:function(){if(this.isImageLoaded){var offset=this.el.getOffsetsTo(this.dragEl);var i=Math.ceil(offset[1]/this.currentLayer.tileSize);var j=Math.ceil(offset[0]/this.currentLayer.tileSize);var rowTiles=Math.ceil(this.el.getHeight()/this.currentLayer.tileSize);var columnTiles=Math.ceil(this.el.getWidth()/this.currentLayer.tileSize);var totalTile=Math.floor(this.dragEl.getWidth()/this.currentLayer.tileSize);var bottomrightX,bottomrightY;var elXY=this.el.getXY();var bottomX=this.el.getWidth()+elXY[0];var bottomY=this.el.getHeight()+elXY[1];var xy=this.dragEl.getXY();var btmX=Math.ceil(Math.abs(xy[1]-bottomY)/this.currentLayer.tileSize);var btmY=Math.ceil(Math.abs(xy[0]-bottomX)/this.currentLayer.tileSize);btmX=(btmX>totalTile)?totalTile:btmX;btmY=(btmY>totalTile)?totalTile:btmY;btmX=(btmX<1)?1:btmX;btmY=(btmY<1)?1:btmY;i=(i<=0)?1:i;j=(j<=0)?1:j;if((totalTile<rowTiles)&&(totalTile<columnTiles)){bottomrightX=i;bottomrightY=j;}else{bottomrightX=btmX;bottomrightY=btmY;}
this.currentLayer.showTilesByRange({row:i,column:j},{row:bottomrightX,column:bottomrightY});}},initKeyEvent:function(){},initMouseEvent:function(){if(this.dblClickZoom){this.enableDblClickZoom();}
if(this.isMouseScroll){this.mon(this.el,'mousewheel',this.onMouseWheel,this);}},loadCopyRight:function(){if(this.copyRightControl&&this.isImageLoaded){this.copyrightDiv=Ext.core.DomHelper.insertFirst(this.el.dom,{tag:'div',cls:'imagezoom-copyright'});this.updateCopyright(this.copyrightText);}},loadDragTracker:function(){this.tracker=Ext.create('Ext.dd.DragTracker',{onStart:Ext.Function.bind(this.onDragStart,this),onDrag:Ext.Function.bind(this.onDrag,this),onEnd:Ext.Function.bind(this.onDragEnd,this),tolerance:3,autoStart:300,el:this.tileContainerEl,scope:this,listeners:{mousedown:function(e){this.addCls('imagezoom-closecursor');},mouseup:function(e){this.removeCls('imagezoom-closecursor');},scope:this}});},loadDrawControl:function(){},loadImage:function(url){this.tileTpl=url;if(this.isImageLoaded){this.resetImage();}
this.isImageLoaded=true;this.zoomTile(this.currentZoomLevel);this.loadZoomControl();this.loadPanControl();this.loadRototeControl();this.loadCopyRight();this.loadScaleControl();this.loadDrawControl();this.fireEvent('afterImageLoad',this);},loadPanControl:function(){if(this.panControl&&this.isImageLoaded){this.mapTag=Ext.core.DomHelper.insertFirst(this.el.dom,{tag:'map',name:"panmap"});this.xtpl=Ext.core.DomHelper.createTemplate({tag:'area',shape:"rect",coords:'{0}',title:'{1}'});this.eastPan=this.xtpl.insertFirst(this.mapTag,["40,20,55,38",'Pan right']);this.westPan=this.xtpl.insertFirst(this.mapTag,["5,20,20,38",'Pan left']);this.centerPan=this.xtpl.insertFirst(this.mapTag,["18,20,40,38",'Return to the last result']);this.northPan=this.xtpl.insertFirst(this.mapTag,["20,5,38,20",'Pan up']);this.southPan=this.xtpl.insertFirst(this.mapTag,["20,35,38,55",'Pan down']);Ext.fly(this.eastPan).on('click',function(){this.moveDragContainer(50,0);},this);Ext.fly(this.northPan).on('click',function(){this.moveDragContainer(0,-50);},this);Ext.fly(this.centerPan).on('click',function(){this.setCenterTile();this.getTileByOffset();if(this.rototeControl){this.rototeContainer.setValue(0);}},this);Ext.fly(this.southPan).on('click',function(){this.moveDragContainer(0,50);},this);Ext.fly(this.westPan).on('click',function(){this.moveDragContainer(-50,0);},this);this.pancontrol=Ext.core.DomHelper.insertFirst(this.el.dom,{tag:'img',src:"resources/images/pan-control.gif",cls:'imagezoom-pancontrol',usemap:"#panmap"});}},loadRototeControl:function(){if(this.rototeControl&&this.isImageLoaded){this.rototeDiv=Ext.core.DomHelper.insertFirst(this.el.dom,{tag:'div',cls:'imagezoom-rototecontrol'});this.rototeContainer=Ext.create('Ext.slider.Single',{renderTo:this.rototeDiv,hideLabel:true,width:200,useTips:false,increment:10,minValue:this.rototeMin,maxValue:this.rototeMax,value:0,listeners:{change:function(slider,newValue,thumb){var value=Ext.util.Format.format('rotate({0}deg)',newValue);this.dragEl.applyStyles({'-webkit-transform':value,'-moz-transform':value});},scope:this}});}},loadScaleControl:function(){if(this.scaleControl&&this.isImageLoaded){var value=183;this.scaleBarDiv=Ext.core.DomHelper.insertFirst(this.el.dom,{tag:'div',id:'scaleBar',cls:'imagezoom-scaleBar'});this.scaleLine=Ext.core.DomHelper.insertFirst(Ext.fly(this.scaleBarDiv).dom,{tag:'div',style:'border-bottom: 2px solid;'});this.scaleValue=Ext.core.DomHelper.insertFirst(Ext.fly(this.scaleBarDiv).dom,{tag:'div',style:'text-align: center; font-weight: bold;'});Ext.fly(this.scaleValue).update('1 in');Ext.fly(this.scaleBarDiv).setWidth(value);}},loadZoomControl:function(){if(this.zoomControl&&this.isImageLoaded){this.zoomContainer=Ext.create('Ext.slider.Single',{renderTo:'zoomControlContainer',hideLabel:true,height:20*(this.zoomMax-this.zoomMin),vertical:true,useTips:false,increment:1,minValue:this.zoomMin,maxValue:this.zoomMax,value:this.currentZoomLevel,listeners:{change:function(slider,newValue,thumb){this.currentZoomLevel=newValue;this.zoomTile(this.currentZoomLevel);this.newDraw();},scope:this}});}},newDraw:function(){},onDrag:function(e){var xy=e.getXY();this.dragEl.setXY([this.cXY[0]-(this.currentPosition[0]-xy[0]),this.cXY[1]-(this.currentPosition[1]-xy[1])]);this.getTileByOffset();},onDragEnd:function(e){this.currentPosition=e.getXY();},onDragStart:function(e){this.currentPosition=e.getXY();this.cXY=this.dragEl.getXY();},onMouseWheel:function(e){var delta=e.getWheelDelta();e.stopEvent();if(delta>0){if(this.currentZoomLevel<this.zoomMax)
this.zoom(e,true);}else if(delta<0){if(this.currentZoomLevel>this.zoomMin)
this.zoom(e,false);}},resetImage:function(){if(this.panControl){Ext.fly(this.pancontrol).remove();Ext.fly(this.mapTag).remove();}
if(this.zoomControl)
this.zoomContainer.el.remove();this.resetDrawControl();if(this.rototeControl){this.rototeContainer.el.remove();Ext.fly(this.rototeDiv).remove();this.dragEl.applyStyles({'-webkit-transform':'rotate(0deg)','-moz-transform':'rotate(0deg)'});}
if(this.copyRightControl)
Ext.fly(this.copyrightDiv).remove();for(var i=0;i<this.tileLayers.length;i++){if(Ext.isDefined(this.tileLayers[i])){this.tileLayers[i].removeTiles();this.tileLayers[i].el.remove();}
delete this.tileLayers[i];}
this.resetObject();this.fireEvent('afterResetImage',this);},resetDrawControl:function(){},resetObject:function(){this.pancontrol='';this.zoomContainer='';this.rototeContainer='';this.copyrightDiv='';this.tilesLayers=[];this.mapTag='';this.rototeDiv='';this.isImageLoaded=false;},setBackgroundColor:function(color){this.el.applyStyles({backgroundColor:color});},setCenterTile:function(){var x=(this.el.getWidth()/2)-(this.dragEl.getWidth()/2);var y=(this.el.getHeight()/2)-(this.dragEl.getHeight()/2);this.dragEl.applyStyles({top:y,left:x});},moveDragContainer:function(x,y){var xy=this.dragEl.getXY();this.dragEl.setX(xy[0]-x);this.dragEl.setY(xy[1]-y);},updateCopyright:function(text){if(this.copyRightControl&&this.isImageLoaded){Ext.fly(this.copyrightDiv).update(text)}},zoom:function(e,flag){if(this.isImageLoaded){var xy=e.getXY();var dragXY=this.dragEl.getXY();var beforeImageSize=this.imageSize;var offsetX=Math.abs(xy[0]-dragXY[0]);var offsetY=Math.abs(xy[1]-dragXY[1]);if(flag){this.zoomIn(e);}else{this.zoomOut(e);}
var afterImageSize=this.imageSize;var newTileCount=afterImageSize/beforeImageSize;var newOffsetX=xy[0]-Math.ceil(offsetX*newTileCount);var newOffsetY=xy[1]-Math.ceil(offsetY*newTileCount);this.dragEl.setXY([newOffsetX,newOffsetY]);this.getTileByOffset();}},zoomIn:function(e){if(this.isImageLoaded){if(this.currentZoomLevel<this.zoomMax){this.currentZoomLevel++;if(this.zoomControl){this.zoomContainer.setValue(this.currentZoomLevel);}
this.zoomTile(this.currentZoomLevel);this.newDraw()}}},zoomOut:function(e){if(this.isImageLoaded){if(this.currentZoomLevel>this.zoomMin){this.currentZoomLevel--;if(this.zoomControl){this.zoomContainer.setValue(this.currentZoomLevel);}
this.zoomTile(this.currentZoomLevel);this.newDraw();}}},zoomTile:function(zoomLevel){if(this.isImageLoaded){if(!Ext.isDefined(this.tileLayers[zoomLevel-1])){this.tileLayers[zoomLevel-1]=Ext.create('SilverMeasure.TileLayer',{renderTo:'dragContainer',zoomLevel:zoomLevel,tileTpl:this.tileTpl});this.currentLayer=this.tileLayers[zoomLevel-1];if(Ext.isDefined(this.previousLayer)){if(this.preivousZoom>zoomLevel){this.currentLayer.el.insertBefore(this.previousLayer.el.dom);}else if(this.preivousZoom<zoomLevel){this.currentLayer.el.insertAfter(this.previousLayer.el.dom);}}}
this.previousLayer=this.tileLayers[this.preivousZoom-1];this.currentLayer=this.tileLayers[zoomLevel-1];if(Ext.isDefined(this.currentLayer)){this.fireEvent('layerChanged',this.currentLayer,this);this.imageSize=(Math.pow(zoomLevel,2)*this.currentLayer.tileSize);}
if(this.preivousZoom!=zoomLevel){if(Ext.isDefined(this.previousLayer)){this.previousLayer.el.setVisible(false);this.currentLayer.el.setVisible(true);}}
this.dragEl.setWidth(this.currentLayer.getWidth());this.getTileByOffset();this.preivousZoom=zoomLevel;}}});

Ext.define('SilverMeasure.ImageZoomPanel',{extend:'Ext.panel.Panel',alias:'widget.imagezoompanel',border:false,autoScroll:true,currentZoomLevel:2,zoomMax:4,backgroundColor:'#000',copyrightText:'Copyright&copy;SilverBiology.com',zoomControl:true,rototeControl:true,scaleControl:true,copyRightControl:true,initComponent:function(){this.imageZoom=Ext.create('SilverMeasure.ImageZoom',{currentZoomLevel:this.currentZoomLevel,zoomMax:this.zoomMax,backgroundColor:this.backgroundColor,copyrightText:this.copyrightText,zoomControl:this.zoomControl,rototeControl:this.rototeControl,scaleControl:this.scaleControl,copyRightControl:this.copyRightControl});this.items=[this.imageZoom];this.callParent();},loadImage:function(url){this.imageZoom.loadImage(url);},resetImage:function(){this.imageZoom.resetImage();}});
